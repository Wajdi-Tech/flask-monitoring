name: CI/CD Flask Monitoring

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Nettoyage propre
        run: |
          docker stop flask-test || true
          docker rm -f flask-test || true
          docker rmi flask-monitoring-app || true

      - name: Build image
        run: docker build -t flask-monitoring-app .

      - name: Test de santé (robuste)
        run: ./test_app.sh

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Déploiement complet
        run: |
          cd advanced-monitoring
          docker-compose down || true
          docker-compose up -d --build
          sleep 15
          curl -f http://localhost:5000 || exit 1
